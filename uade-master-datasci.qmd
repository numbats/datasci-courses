---
title: "Master of Data Science - University of Adelaide"
author: "Tina Tsou"
date: "`r Sys.Date()`"
format: 
  html: 
    code-fold: false
---


```{r setup, include = FALSE}
library(tidyverse)
library(rvest)
library(RSelenium)
library(seleniumPipes)
library(glue)
knitr::opts_chunk$set(echo = FALSE,
                      cache = TRUE,
                      cache.path = "cache/",
                      fig.path = "images/")

```


```{r adelaide}
rD <- rsDriver(browser="firefox", port=4779L, verbose=F)
remDr <- rD[["client"]]


course_codes <- c("mdsci_mdatasci", "mdsa_mdscapol")
baseurl<- "https://calendar.adelaide.edu.au/aprcw/2022/"
wait_time <- function() Sys.sleep(sample(3:5, 1))

data <- tibble(Course = character(),
               Course_code = character(),
               Unit = character(),
               Unit_code = character(),
               Overview = character(),
               Outcome = character(),
               Prohibition = character(),
               Prerequisite = character(),
               Corequisite = character())

for(code in course_codes) {
  remDr$navigate(glue("{baseurl}{code}"))
  wait_time()
  course_html <- read_html(remDr$getPageSource()[[1]])
  
tryCatch({
    title <- course_html %>% 
        html_element("#page-title") %>% 
        html_text() %>% 
        str_trim()

    code <- course_html %>% 
          html_element("div.span4:nth-child(1)") %>% 
          html_element(" p:nth-child(2)") %>% 
          html_text()
    
    if(code == "mdsci_mdatasci"){
      corecourses <-course_html %>% 
      html_element("#tab-corecourses") %>% 
      html_element("fieldset:nth-child(3)") %>% 
      html_element("div:nth-child(2)") %>% 
      html_element("table:nth-child(4)") %>% 
      html_element("tbody:nth-child(2)") %>% 
      html_children() %>% 
      html_element("a") %>% 
      html_attr("href") %>% as_tibble()
      
      project <- course_html %>% 
       html_element("#tab-mode") %>% 
      html_element("fieldset:nth-child(3)") %>% 
      html_element("div:nth-child(2)") %>% 
      html_elements("table") %>% 
      html_element("tbody") %>% 
      html_children() %>% 
      html_element("a") %>% 
      html_attr("href")%>% as_tibble()
    
    electives <- course_html %>% 
       html_element("#tab-electives") %>% 
      html_element("fieldset:nth-child(3)") %>% 
      html_element("div:nth-child(2)") %>% 
      html_elements("table") %>% 
      html_element("tbody") %>% 
      html_children() %>% 
      html_element("a") %>% 
      html_attr("href")%>% as_tibble()
      curriculum <- rbind(corecourses, electives) %>% rbind(project)
    }else{
        curriculum <-course_html %>% 
      html_element("#tab-corecourses") %>% 
      html_element("fieldset:nth-child(3)") %>% 
      html_element("div:nth-child(2)") %>% 
      html_elements("table") %>% 
      html_element("tbody") %>% 
      html_children() %>% 
      html_element("a") %>% 
      html_attr("href")
      }

    for(unit in curriculum) {
      remDr$navigate(glue("http:{unit}"))
      wait_time()
      webElem<- remDr$findElement(
        using = "css",
                "html body div.keyline table tbody tr td div.content p table tbody tr td.odd a")
      webElem$clickElement()
      wait_time()
      webElem2<- remDr$findElement(
        using = "xpath",
                "/html/body/div[1]/table[4]/tbody/tr/td/div/a[2]")
      webElem2$clickElement()
      wait_time()
      unit_html <- read_html(remDr$getPageSource()[[1]])
      
      ## get the course name and course number of each course
      unitinfo <- unit_html %>% 
        html_element("li.accordion-item:nth-child(1)") %>% 
        html_element("div:nth-child(2)") %>% 
        html_element("div:nth-child(2)") %>% 
        html_table()
      
      unitname <- unitinfo %>% 
                    filter(X1 == 'Course') %>% 
                    select(X2) %>% 
                    as.character()
      
      unitcode <- unitinfo %>% 
                    filter(X1 == 'Course Code') %>% 
                    select(X2) %>% 
                    as.character()

      #message(paste("Going through the unit:", cunit[,2]))
      
      ## get the overview of the unit
      overview <- unitinfo %>% 
                    filter(X1 == 'Course Description') %>% 
                    select(X2) %>% 
                    as.character()
      
      
      ## prerequisite 
       if('Prerequisites' %in% unitinfo$X1){
                pre <- unitinfo %>% 
                  filter(X1 == 'Prerequisites') %>% 
                  select(X2) %>% 
                  as.character()}else{pre <- NA}
       
       ## prohibition
       if('Incompatible' %in% unitinfo$X1){
                 pro <-  unitinfo %>% 
                    filter(X1 == 'Incompatible') %>% 
                    select(X2) %>% 
                    as.character()}else{pro <- NA}
       
       if('Corequisite' %in% unitinfo$X1){
                co <-unitinfo %>% 
                  filter(X1 == 'Corequisite') %>% 
                  select(X2) %>% 
                  as.character()}else{co <-NA}

        ##learning outcomes
      lc <- possibly({
        unit_html %>% 
          html_element(".ui-accordion-content-active") %>% 
          html_element("div:nth-child(2)")
        }, otherwise = "error" )
      
      if(length(lc) > 0) {
        lc <- unit_html %>% 
          html_element(".ui-accordion-content-active") %>% 
          html_element("div:nth-child(2)") %>% 
          html_element("div:nth-child(1)") %>% 
          html_text() %>% str_remove_all("\n        ") 
      } else {
        lc <- NA
      }
      
      data <- data %>% 
        bind_rows(tibble(!!!list(Course = title, 
                                   Course_code = code, 
                                   Unit = unitname,
                                   Unit_code = unitcode,
                                   Overview = overview,
                                   Outcomes =lc,
                                  Prohibition = pro,
                                  Prerequisite= pre,
                                 Corequisite = co))) %>% 
        mutate(Prohibition = na_if(Prohibition, "character(0)"))
      }
      
    }, error = function(x) x)
  }


# stop the rselenium server
#rD[["server"]]$stop()
```
